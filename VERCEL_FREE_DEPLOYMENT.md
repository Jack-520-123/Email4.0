# Vercel 免费版部署指南

## 概述

本邮件群发系统已针对 Vercel 免费版进行了优化，实现了智能发送策略，无需依赖频繁的 CRON 任务即可实现一封一封的邮件发送。

## 智能发送策略

### 策略说明

系统根据用户设置的发送间隔自动选择最优的发送策略：

1. **短间隔发送（< 2分钟）**
   - 在单次执行中连续发送
   - 适用于快速批量发送场景
   - 受 Vercel 函数执行时间限制（最大5分钟）

2. **中间隔发送（2-10分钟）**
   - 使用递归 HTTP 调用策略
   - 每次发送一封邮件后，通过内部 API 调用继续下一封
   - 避免单次执行时间过长

3. **长间隔发送（> 10分钟）**
   - 设置下次发送时间
   - 用户可手动触发继续发送
   - 适用于定时营销场景

### 执行时间保护

- 单次执行超过 4.5 分钟时自动退出
- 保存当前发送进度，支持断点续传
- 避免 Vercel 函数超时

## 功能特性

### 1. 实时状态监控

- **发送进度显示**：实时显示发送进度条和统计信息
- **状态自动刷新**：发送中的活动每5秒自动刷新状态
- **智能策略提示**：显示当前使用的发送策略

### 2. 灵活的发送控制

- **暂停发送**：随时暂停正在进行的发送任务
- **继续发送**：从上次停止的位置继续发送
- **停止发送**：完全停止发送任务
- **手动触发**：支持手动触发继续发送

### 3. 断点续传

- 自动保存发送进度
- 系统重启或异常中断后可继续发送
- 避免重复发送已成功的邮件

## 使用指南

### 1. 创建邮件活动

1. 登录系统，进入「活动管理」
2. 点击「创建新活动」
3. 配置邮件模板、收件人列表、发送配置
4. 设置合适的发送间隔：
   - 快速发送：30秒 - 2分钟
   - 稳定发送：2分钟 - 10分钟
   - 定时发送：> 10分钟

### 2. 启动发送

1. 在活动详情页点击「启动活动」
2. 系统自动根据间隔选择发送策略
3. 实时监控发送状态和进度

### 3. 发送控制

- **暂停**：临时停止发送，可随时继续
- **继续**：从暂停位置继续发送
- **停止**：完全终止发送任务

### 4. 监控发送状态

- 查看实时发送进度
- 监控成功/失败统计
- 查看详细发送记录
- 了解当前使用的发送策略

## 技术实现

### 1. 智能策略选择

```typescript
// 根据间隔和执行时间选择策略
if (intervalMs > 10 * 60 * 1000 || executionTime > 4.5 * 60 * 1000) {
  // 长间隔或执行时间过长：设置下次发送时间
  await setNextSendTime()
} else if (intervalMs >= 2 * 60 * 1000) {
  // 中间隔：递归调用
  await continueViaSelfCall()
} else {
  // 短间隔：当前执行中等待
  await sleep(intervalMs)
}
```

### 2. 递归调用机制

```typescript
// 通过内部 HTTP 请求继续发送
const response = await fetch(`/api/campaigns/${campaignId}/continue-sending`, {
  method: 'POST',
  headers: {
    'X-Internal-Call': 'true'
  }
})
```

### 3. 状态管理

- 使用全局 `runningTasks` 管理正在运行的任务
- `AbortController` 支持任务取消
- 数据库持久化发送进度

## 部署配置

### 1. 环境变量

确保在 Vercel 中配置以下环境变量：

```bash
DATABASE_URL=your_database_url
NEXTAUTH_SECRET=your_nextauth_secret
NEXTAUTH_URL=your_app_url
# 其他必要的环境变量
```

### 2. 函数配置

```json
{
  "functions": {
    "src/app/api/**/*.ts": {
      "maxDuration": 60
    }
  }
}
```

### 3. 移除 CRON 配置

免费版不支持频繁 CRON，已从 `vercel.json` 中移除相关配置。

## 最佳实践

### 1. 发送间隔设置

- **营销邮件**：建议 2-5 分钟间隔
- **通知邮件**：建议 30秒-2分钟间隔
- **定时推送**：建议 > 10分钟间隔

### 2. 收件人数量

- 单次活动建议不超过 10,000 个收件人
- 大量发送可分批创建多个活动

### 3. 监控和维护

- 定期查看发送状态
- 及时处理失败的邮件
- 监控邮件送达率和打开率

## 故障排除

### 1. 发送中断

- 检查网络连接
- 验证 SMTP 配置
- 查看错误日志
- 使用「继续发送」功能恢复

### 2. 发送缓慢

- 适当调整发送间隔
- 检查 SMTP 服务器限制
- 考虑分批发送

### 3. 状态不更新

- 刷新页面
- 检查浏览器控制台错误
- 验证 API 响应

## 升级建议

如需更高的发送频率和更稳定的服务，建议：

1. **升级 Vercel Pro**：支持更多 CRON 任务和更长执行时间
2. **使用专用服务器**：部署到 VPS 或云服务器
3. **集成专业邮件服务**：如 SendGrid、Mailgun 等

## 总结

通过智能发送策略，本系统在 Vercel 免费版限制下仍能实现高效的邮件群发功能。用户可以根据实际需求选择合适的发送间隔，系统会自动选择最优的发送策略，确保邮件能够稳定、持续地发送。