# Serverless 环境优化说明

本文档说明了为适配 Vercel 等 Serverless 环境而进行的系统优化。

## 主要问题

在 Serverless 环境中，函数有执行时间限制（通常为 10-300 秒），长时间运行的 `setTimeout` 和循环等待会导致函数超时或被中断。

## 优化方案

### 1. 定时发送任务重构

**原有方案：**
- 使用 `setTimeout` 等待定时时间
- 在单个函数中完成整个发送流程

**优化后方案：**
- 创建 Vercel cron 任务 (`/api/cron/process-scheduled-campaigns`)
- 每分钟检查需要发送的活动
- 将长时间等待改为状态检查

### 2. 批次处理优化

**原有方案：**
- 批次间使用长时间 `setTimeout` 等待（60-120秒）
- 单次函数处理所有邮件

**优化后方案：**
- 每次处理一个批次后立即返回
- 由 cron 任务定期调用继续处理
- 减少单次函数执行时间

### 3. 延迟时间调整

**邮件发送间隔：**
- 原：2-6秒随机延迟
- 现：0.5-1.5秒随机延迟

**API 调用延迟：**
- 原：2-3秒延迟
- 现：0.5秒延迟

### 4. 任务状态管理

**暂停处理：**
- 原：循环等待直到恢复
- 现：检查到暂停状态直接返回

**时间窗口检查：**
- 原：等待60秒后重新检查
- 现：不在时间窗口内直接返回

## 配置文件

### vercel.json
```json
{
  "functions": {
    "src/app/api/**/*.ts": {
      "maxDuration": 300
    }
  },
  "crons": [
    {
      "path": "/api/cron/process-scheduled-campaigns",
      "schedule": "* * * * *"
    }
  ]
}
```

### 新增 API 路由
- `/api/cron/process-scheduled-campaigns` - 处理定时发送任务的 cron 端点

## 优化效果

1. **避免函数超时**：单次执行时间大幅减少
2. **提高可靠性**：不依赖长时间运行的进程
3. **更好的资源利用**：按需执行，避免资源浪费
4. **保持功能完整性**：所有原有功能正常工作

## 注意事项

1. **cron 频率**：当前设置为每分钟执行一次，可根据需要调整
2. **批次大小**：建议根据邮件发送速度调整批次大小
3. **监控**：建议添加日志监控确保 cron 任务正常运行
4. **环境变量**：确保 Vercel 环境中配置了所有必要的环境变量

## 兼容性

本优化保持了与原有系统的完全兼容性：
- 所有 API 接口保持不变
- 前端界面无需修改
- 数据库结构无变化
- 用户体验保持一致