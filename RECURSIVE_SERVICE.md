# 递归服务使用指南

## 概述

本系统实现了递归调用机制来持续运行任务恢复服务，专为Vercel免费账户设计，无需依赖CRON功能。

## 功能特点

- ✅ **智能自动启动**: 启动邮件发送或预热任务时自动启动递归服务，零配置
- ✅ **递归执行**: 服务启动后自动递归调用，无需外部定时器
- ✅ **免费友好**: 适用于Vercel免费账户，不依赖CRON功能
- ✅ **自动恢复**: 自动检查和恢复中断的邮件发送任务
- ✅ **状态监控**: 实时监控服务运行状态
- ✅ **手动控制**: 支持手动启动和停止服务

## 核心组件

### 1. 任务恢复服务 (`TaskRecoveryService`)

位置: `src/lib/task-recovery.ts`

**主要功能:**
- 递归健康检查 (每5分钟执行一次)
- 清理僵尸任务
- 检查超时任务
- 恢复待发送任务
- 邮件发送处理

**关键方法:**
- `initialize()`: 初始化服务
- `startHealthCheck()`: 启动递归健康检查
- `stopHealthCheck()`: 停止递归健康检查
- `shutdown()`: 完全停止服务

### 2. 预热任务服务 (`WarmupRecoveryService`)

位置: `src/lib/warmup-recovery.ts`

**主要功能:**
- 邮件预热任务管理
- 自动轮询发送
- 任务状态跟踪

**关键方法:**
- `initialize()`: 初始化预热服务
- `shutdown()`: 停止预热服务

### 3. 应用初始化器 (`app-initializer`)

位置: `src/lib/app-initializer.ts`

**主要功能:**
- 统一管理服务初始化
- 提供启动和停止接口

**关键方法:**
- `initializeApp()`: 初始化所有服务
- `shutdownApp()`: 停止所有服务
- `isAppInitialized()`: 检查初始化状态

## API 端点

### 启动服务

```http
POST /api/start-service
```

**响应示例:**
```json
{
  "success": true,
  "message": "递归服务启动成功",
  "status": "started",
  "timestamp": "2024-01-01T00:00:00.000Z"
}
```

### 停止服务

```http
POST /api/stop-service
```

**响应示例:**
```json
{
  "success": true,
  "message": "递归服务停止成功",
  "status": "stopped",
  "timestamp": "2024-01-01T00:00:00.000Z"
}
```

### 检查服务状态

```http
GET /api/start-service
GET /api/stop-service
```

**响应示例:**
```json
{
  "success": true,
  "isRunning": true,
  "status": "running",
  "timestamp": "2024-01-01T00:00:00.000Z"
}
```

## 管理界面

### 服务控制面板

访问路径: `/service-control`

**功能:**
- 实时显示服务状态
- 手动启动/停止服务
- 自动状态刷新 (每30秒)
- 操作日志显示

**权限要求:** 所有注册用户均可访问

## 使用流程

### 1. 部署到Vercel

1. 将代码推送到Git仓库
2. 在Vercel中导入项目
3. 配置环境变量
4. 部署应用

### 2. 自动启动 (推荐)

递归服务现已支持**智能自动启动**，无需手动操作：

- **邮件发送任务启动时**: 系统自动启动递归服务
- **预热任务启动时**: 系统自动启动递归服务
- **零配置**: 用户只需正常使用邮件功能，递归服务会自动运行

### 3. 手动控制 (可选)

如需手动控制服务状态，可使用以下方式：

**方法一: 通过管理界面**
1. 登录系统 (任意注册用户)
2. 访问 "服务控制" 页面
3. 点击 "启动服务" 或 "停止服务" 按钮

**方法二: 通过API调用**
```bash
# 启动服务
curl -X POST https://your-domain.vercel.app/api/start-service

# 停止服务
curl -X POST https://your-domain.vercel.app/api/stop-service
```

### 4. 服务状态监控

**实时状态查看:**
- 访问 "服务控制" 页面查看服务运行状态
- 页面每30秒自动刷新状态
- 显示服务启动时间和运行状态

## 工作原理

### 递归机制

```javascript
// 递归健康检查实现
async recursiveHealthCheck() {
  if (!this.isInitialized || !this.isRecursiveRunning) {
    return; // 停止递归
  }
  
  try {
    await this.performHealthCheck();
  } catch (error) {
    console.error('健康检查失败:', error);
  }
  
  // 5分钟后递归调用
  setTimeout(() => {
    this.recursiveHealthCheck();
  }, 5 * 60 * 1000);
}
```

### 任务恢复流程

1. **健康检查启动**: 每5分钟执行一次
2. **僵尸任务清理**: 清理长时间无响应的任务
3. **超时任务检查**: 检查并重启超时的任务
4. **待发送任务**: 启动新的邮件发送任务
5. **状态更新**: 更新任务和数据库状态

## 注意事项

### Vercel限制

- **函数超时**: 免费账户函数最长运行10秒
- **并发限制**: 同时运行的函数数量有限
- **内存限制**: 每个函数最大1GB内存

### 最佳实践

1. **定期监控**: 通过管理界面检查服务状态
2. **日志查看**: 定期查看Vercel函数日志
3. **数据备份**: 定期备份数据库数据
4. **错误处理**: 关注错误日志并及时处理

### 故障排除

**服务无法启动:**
- 检查数据库连接
- 验证环境变量配置
- 查看Vercel函数日志

**任务不执行:**
- 确认服务已启动
- 检查数据库中的任务状态
- 验证邮件配置

**递归停止:**
- 重新启动服务
- 检查错误日志
- 验证系统资源

## 技术细节

### 状态管理

- 使用内存变量跟踪服务状态
- 数据库记录任务执行状态
- 支持服务重启后状态恢复

### 错误处理

- 全面的try-catch错误捕获
- 详细的错误日志记录
- 自动重试机制

### 性能优化

- 批量数据库操作
- 合理的执行间隔
- 内存使用优化

## 更新日志

### v1.0.0
- 实现基础递归服务功能
- 添加服务控制面板
- 支持手动启动/停止
- 完善错误处理和日志记录